<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Frequência - EscolaSystem</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2a9d8f; /* Um verde mais vibrante */
        --dark-blue: #264653; /* Azul escuro */
        --light-grey: #f8f9fa;
        --border-color: #dee2e6;
        --text-muted: #6c757d;
      }

      body {
        background-color: var(--light-grey);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .sidebar {
        height: 100vh;
        background-color: #fff;
        border-right: 1px solid var(--border-color);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
      }

      .sidebar .nav-link {
        color: var(--dark-blue);
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      .sidebar .nav-link:hover {
        background-color: #f0f2f5;
        color: var(--primary-color);
      }

      .sidebar .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
        font-weight: 600;
      }

      .sidebar .nav-link.active:hover {
        background-color: var(--primary-color);
        color: #fff;
      }

      .sidebar h5 {
        color: var(--dark-blue);
        font-weight: 700;
        margin-bottom: 2rem;
      }

      .sidebar .text-muted.small {
        font-size: 0.8rem;
        margin-bottom: 1rem;
        color: var(--text-muted) !important;
      }

      .sidebar .mt-5 {
        margin-top: auto !important;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      .card-counter {
        border: none;
        border-radius: 0.75rem;
        padding: 1.2rem;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
      }

      .card-counter:hover {
        transform: translateY(-3px);
      }

      .card-counter .text-muted.small {
        font-size: 0.85rem;
        color: var(--text-muted) !important;
      }

      .card-counter .fs-4 {
        font-size: 1.8rem !important;
      }

      .table thead th {
        background-color: var(--dark-blue) !important;
        color: white !important;
        font-weight: 600;
      }

      .table td, .table th {
          vertical-align: middle;
      }

      .form-select, .form-control {
          border-radius: 0.5rem;
          border-color: var(--border-color);
      }

      .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(42, 157, 143, 0.25);
      }

      .btn-success {
        background-color: #28a745; /* Verde Bootstrap padrão */
        border-color: #28a745;
        font-weight: 500;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
      }

      .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-2 sidebar d-none d-md-flex flex-column p-3">
          <h5 class="mb-4">EscolaSystem</h5>
          <p class="text-muted small">Gestão Acadêmica</p>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="alunos.html">
                <i class="bi bi-person-fill me-2"></i>Alunos
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="turmas.html">
                <i class="bi bi-people-fill me-2"></i>Turmas
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="frequencia.html">
                <i class="bi bi-check2-square me-2"></i>Frequência
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="relatorios.html">
                <i class="bi bi-bar-chart-line-fill me-2"></i>Relatórios
              </a>
            </li>
          </ul>
          <div class="mt-5">
            <small class="text-muted">Usuário Logado</small>
            <div class="fw-bold">Professor</div>
            <div class="text-muted small">professor@gmail.com</div>
            <span class="badge bg-dark mt-2">Professor</span>
          </div>
          <button class="btn btn-outline-secondary btn-sm mt-4">
            <i class="bi bi-box-arrow-right me-1"></i>Sair do Sistema
          </button>
        </nav>

        <main class="col-md-10 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h3>Registro de Frequência</h3>
              <p class="text-muted">
                Registre a presença dos alunos e acompanhe a assiduidade.
              </p>
            </div>
          </div>

          <div class="card p-4 mb-4 shadow-sm">
            <h5>Configurações da Aula</h5>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label for="turmaSelect" class="form-label">Turma</label>
                <select class="form-select" id="turmaSelect">
                  <option value="">Selecione a Turma</option>
                  </select>
              </div>
              <div class="col-md-6">
                <label for="dataAula" class="form-label">Data da Aula</label>
                <input type="date" class="form-control" id="dataAula" />
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card-counter">
                <div class="text-muted small">Total de Alunos na Turma</div>
                <div class="fs-4 fw-bold" id="totalAlunosTurma">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card-counter">
                <div class="text-muted small">Presentes</div>
                <div class="fs-4 fw-bold text-success" id="presentesCount">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card-counter">
                <div class="text-muted small">Ausentes</div>
                <div class="fs-4 fw-bold text-danger" id="ausentesCount">0</div>
              </div>
            </div>
          </div>

          <div class="card p-4 shadow-sm">
            <h5>Lista de Chamada</h5>
            <table class="table table-bordered table-hover mt-3">
              <thead>
                <tr>
                  <th>Aluno</th>
                  <th>Matrícula</th>
                  <th style="width: 25%">Presença</th>
                  <th>Observações</th>
                </tr>
              </thead>
              <tbody id="listaChamadaBody">
                <tr>
                    <td colspan="4" class="text-center text-muted">Selecione uma turma e uma data para carregar a lista de chamada.</td>
                </tr>
                </tbody>
            </table>
            <button class="btn btn-success mt-3" id="saveFrequenciaBtn" disabled>
              <i class="bi bi-save me-2"></i>Salvar Frequência
            </button>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Dados Mockados (Simulação de Backend) ---
      const alunosData = [
        { id: 'a1', nome: "Ana Silva Santos", email: "ana.santos@email.com", matricula: "20240001", turmaId: "t1" },
        { id: 'a2', nome: "João Pedro Oliveira", email: "joao.oliveira@email.com", matricula: "20240002", turmaId: "t1" },
        { id: 'a3', nome: "Beatriz Costa Lima", email: "beatriz.lima@email.com", matricula: "20240003", turmaId: "t2" },
        { id: 'a4', nome: "Gabriel Ferreira Souza", email: "gabriel.souza@email.com", matricula: "20240004", turmaId: "t3" },
        { id: 'a5', nome: "Larissa Mendes Ribeiro", email: "larissa.ribeiro@email.com", matricula: "20240005", turmaId: "t2" },
        { id: 'a6', nome: "Carlos Eduardo Neves", email: "carlos.neves@email.com", matricula: "20240006", turmaId: "t1" },
        { id: 'a7', nome: "Mariana Almeida Dias", email: "mariana.dias@email.com", matricula: "20240007", turmaId: "t1" },
        { id: 'a8', nome: "Rafael Santos Pereira", email: "rafael.pereira@email.com", matricula: "20240008", turmaId: "t2" },
      ];

      const turmasData = [
        { id: 't1', nome: "Turma A", serie: "1º Ano" },
        { id: 't2', nome: "Turma A", serie: "2º Ano" },
        { id: 't3', nome: "Turma B", serie: "1º Ano" },
      ];

      // Simula um registro de frequência pré-existente
      let frequenciaRegistrada = {}; // { 'turmaId-data': [{alunoId: 'status', obs: ''}] }

      // --- Elementos DOM ---
      const turmaSelect = document.getElementById("turmaSelect");
      const dataAulaInput = document.getElementById("dataAula");
      const listaChamadaBody = document.getElementById("listaChamadaBody");
      const totalAlunosTurmaEl = document.getElementById("totalAlunosTurma");
      const presentesCountEl = document.getElementById("presentesCount");
      const ausentesCountEl = document.getElementById("ausentesCount");
      const saveFrequenciaBtn = document.getElementById("saveFrequenciaBtn");

      // --- Funções de Ajuda ---
      function getTurmaNomeCompleto(turmaId) {
        const turma = turmasData.find(t => t.id === turmaId);
        return turma ? `${turma.nome} - ${turma.serie}` : 'N/A';
      }

      function updateCounts() {
        let presentes = 0;
        let ausentes = 0;
        document.querySelectorAll('#listaChamadaBody input[type="radio"]:checked').forEach((el) => {
          if (el.value === "presente") {
            presentes++;
          } else {
            ausentes++;
          }
        });
        presentesCountEl.textContent = presentes;
        ausentesCountEl.textContent = ausentes;
      }

      async function loadTurmas() {
        // Simula busca de turmas no backend
        await new Promise(resolve => setTimeout(resolve, 300));
        turmaSelect.innerHTML = '<option value="">Selecione a Turma</option>';
        turmasData.forEach(turma => {
          const option = document.createElement('option');
          option.value = turma.id;
          option.textContent = getTurmaNomeCompleto(turma.id);
          turmaSelect.appendChild(option);
        });
      }

      async function loadChamada() {
        const turmaId = turmaSelect.value;
        const dataAula = dataAulaInput.value;

        listaChamadaBody.innerHTML = ''; // Limpa a tabela

        if (!turmaId || !dataAula) {
          totalAlunosTurmaEl.textContent = '0';
          presentesCountEl.textContent = '0';
          ausentesCountEl.textContent = '0';
          saveFrequenciaBtn.disabled = true;
          listaChamadaBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Selecione uma turma e uma data para carregar a lista de chamada.</td></tr>`;
          return;
        }

        saveFrequenciaBtn.disabled = false; // Habilita o botão Salvar

        // Simula busca de alunos da turma e frequência anterior (se houver)
        await new Promise(resolve => setTimeout(resolve, 700));

        const alunosDaTurma = alunosData.filter(aluno => aluno.turmaId === turmaId);
        totalAlunosTurmaEl.textContent = alunosDaTurma.length;

        const key = `${turmaId}-${dataAula}`;
        const frequenciaAnterior = frequenciaRegistrada[key] || {}; // Obter registro ou vazio

        if (alunosDaTurma.length === 0) {
            listaChamadaBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Nenhum aluno encontrado para esta turma.</td></tr>`;
            presentesCountEl.textContent = '0';
            ausentesCountEl.textContent = '0';
            saveFrequenciaBtn.disabled = true;
            return;
        }

        alunosDaTurma.forEach(aluno => {
          const statusAluno = frequenciaAnterior[aluno.id] ? frequenciaAnterior[aluno.id].status : 'presente'; // Padrão 'presente'
          const obsAluno = frequenciaAnterior[aluno.id] ? frequenciaAnterior[aluno.id].observacao : '';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${aluno.nome}<br><small class="text-muted">${aluno.email}</small></td>
            <td>${aluno.matricula}</td>
            <td>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="presenca-${aluno.id}" id="presente-${aluno.id}" value="presente" ${statusAluno === 'presente' ? 'checked' : ''}>
                <label class="form-check-label" for="presente-${aluno.id}">Presente</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="presenca-${aluno.id}" id="ausente-${aluno.id}" value="ausente" ${statusAluno === 'ausente' ? 'checked' : ''}>
                <label class="form-check-label" for="ausente-${aluno.id}">Ausente</label>
              </div>
            </td>
            <td><input type="text" class="form-control form-control-sm" data-aluno-id="${aluno.id}" value="${obsAluno}" placeholder="Observações (opcional)"></td>
          `;
          listaChamadaBody.appendChild(row);
        });

        // Adiciona listeners para atualizar contadores dinamicamente
        document.querySelectorAll('#listaChamadaBody input[type="radio"]').forEach(radio => {
          radio.addEventListener('change', updateCounts);
        });
        updateCounts(); // Atualiza os contadores iniciais
      }

      async function saveFrequencia() {
        const turmaId = turmaSelect.value;
        const dataAula = dataAulaInput.value;

        if (!turmaId || !dataAula) {
          alert('Por favor, selecione a turma e a data da aula.');
          return;
        }

        const frequenciaAtual = {};
        const alunosDaTurma = alunosData.filter(aluno => aluno.turmaId === turmaId);

        alunosDaTurma.forEach(aluno => {
          const status = document.querySelector(`input[name="presenca-${aluno.id}"]:checked`);
          const observacaoInput = document.querySelector(`input[data-aluno-id="${aluno.id}"]`);

          frequenciaAtual[aluno.id] = {
            status: status ? status.value : 'ausente', // Default para ausente se não marcado
            observacao: observacaoInput ? observacaoInput.value : ''
          };
        });

        // Simula envio para o backend
        console.log('Dados de frequência a serem salvos:', { turmaId, dataAula, frequencia: frequenciaAtual });
        await new Promise(resolve => setTimeout(resolve, 800)); // Simula latência

        // Salva na simulação de backend
        frequenciaRegistrada[`${turmaId}-${dataAula}`] = frequenciaAtual;

        alert('Frequência salva com sucesso!');
      }

      // --- Event Listeners ---
      turmaSelect.addEventListener('change', loadChamada);
      dataAulaInput.addEventListener('change', loadChamada);
      saveFrequenciaBtn.addEventListener('click', saveFrequencia);

      // --- Inicialização ---
      document.addEventListener('DOMContentLoaded', loadTurmas);
    </script>
  </body>
</html>